################################
# ðŸ¦Ž KOMODO COMPOSE - MONGO ðŸ¦Ž #
################################
services:
  mongo:
    image: mongo@sha256:6f55a078e025aa29fea2826c82f67ff2f774b82efd816c4c30bbfe67904f0bb8
    labels:
      komodo.skip:
    command: --quiet --wiredTigerCacheSizeGB 0.25
    restart: unless-stopped
    volumes:
      - mongo-data:/data/db
      - mongo-config:/data/configdb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${KOMODO_DB_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${KOMODO_DB_PASSWORD}
      TZ: ${TZ}
    networks:
      - thinknetwork

  core:
    image: ghcr.io/moghtech/komodo-core@sha256:a1cceb4f971443b1e9f2a767788f663d0afb6244ee2135f7fe3fd1036af37ade
    labels:
      komodo.skip:
      traefik.enable: "true"
      traefik.http.routers.komodo.rule: "Host(`komodo.thinkcenter.dev`)"
      traefik.http.routers.komodo.entrypoints: "websecure"
      traefik.http.routers.komodo.tls: "true"
      traefik.http.services.komodo.loadbalancer.server.port: "9120"
    restart: unless-stopped
    depends_on:
      - mongo
    ports:
      - 9120:9120
    environment:
      KOMODO_DATABASE_ADDRESS: mongo:27017
      KOMODO_DATABASE_USERNAME: ${KOMODO_DB_USERNAME}
      KOMODO_DATABASE_PASSWORD: ${KOMODO_DB_PASSWORD}
      KOMODO_PASSKEY: ${KOMODO_PASSKEY}
      KOMODO_HOST: ${KOMODO_HOST}
      KOMODO_TITLE: ${KOMODO_TITLE}
      KOMODO_FIRST_SERVER: ${KOMODO_FIRST_SERVER}
      KOMODO_FIRST_SERVER_NAME: ${KOMODO_FIRST_SERVER_NAME}
      KOMODO_MONITORING_INTERVAL: ${KOMODO_MONITORING_INTERVAL}
      KOMODO_RESOURCE_POLL_INTERVAL: ${KOMODO_RESOURCE_POLL_INTERVAL}
      KOMODO_WEBHOOK_SECRET: ${KOMODO_WEBHOOK_SECRET}
      KOMODO_JWT_SECRET: ${KOMODO_JWT_SECRET}
      KOMODO_JWT_TTL: ${KOMODO_JWT_TTL}
      KOMODO_LOCAL_AUTH: ${KOMODO_LOCAL_AUTH}
      KOMODO_INIT_ADMIN_USERNAME: ${KOMODO_INIT_ADMIN_USERNAME}
      KOMODO_INIT_ADMIN_PASSWORD: ${KOMODO_INIT_ADMIN_PASSWORD}
      KOMODO_DISABLE_USER_REGISTRATION: ${KOMODO_DISABLE_USER_REGISTRATION}
      KOMODO_ENABLE_NEW_USERS: ${KOMODO_ENABLE_NEW_USERS}
      KOMODO_DISABLE_NON_ADMIN_CREATE: ${KOMODO_DISABLE_NON_ADMIN_CREATE}
      KOMODO_LOGGING_PRETTY: ${KOMODO_LOGGING_PRETTY}
      KOMODO_PRETTY_STARTUP_CONFIG: ${KOMODO_PRETTY_STARTUP_CONFIG}
      TZ: ${TZ}
    volumes:
      - komodo-backups:/backups
    networks:
      - thinknetwork

  periphery:
    image: ghcr.io/moghtech/komodo-periphery@sha256:bd79cf960ed054fe8e02384322303e462448679b1149dde48bbef151417255b1
    labels:
      komodo.skip:
    restart: unless-stopped
    environment:
      PERIPHERY_PASSKEYS: ${KOMODO_PASSKEY}
      PERIPHERY_DISABLE_TERMINALS: ${PERIPHERY_DISABLE_TERMINALS}
      PERIPHERY_SSL_ENABLED: ${PERIPHERY_SSL_ENABLED}
      PERIPHERY_INCLUDE_DISK_MOUNTS: ${PERIPHERY_INCLUDE_DISK_MOUNTS}
      PERIPHERY_LOGGING_PRETTY: ${PERIPHERY_LOGGING_PRETTY}
      PERIPHERY_PRETTY_STARTUP_CONFIG: ${PERIPHERY_PRETTY_STARTUP_CONFIG}
      PERIPHERY_LOGGING_OTLP_ENDPOINT: ${PERIPHERY_LOGGING_OTLP_ENDPOINT}
      PERIPHERY_LOGGING_OPENTELEMETRY_SERVICE_NAME: ${PERIPHERY_LOGGING_OPENTELEMETRY_SERVICE_NAME}
      TZ: ${TZ}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /proc:/proc
      - periphery-data:/etc/komodo
      - komodo-backups:/backups
    networks:
      - thinknetwork

volumes:
  mongo-data:
  mongo-config:
  periphery-data:
  komodo-backups:

networks:
  thinknetwork:
    external: true
