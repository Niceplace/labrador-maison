name: Renovate Config Validator

on:
  # Run when either Renovate config file is modified
  push:
    paths:
      - '.github/renovate-config.js'
      - '.github/renovate.json5'
  # Allow manual triggering for testing
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run Renovate Config Validator
        id: validate
        run: |
          npx --yes --package renovate -- renovate-config-validator \
            --no-global \
            .github/renovate-config.js \
            .github/renovate.json5 2>&1 | tee renovate-validation-output.log

      - name: Upload validation output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: renovate-validation-output
          path: renovate-validation-output.log
          retention-days: 30

      - name: Display validation results
        if: always()
        run: |
          if [ -s renovate-validation-output.log ]; then
            echo "=== Validation Results ===" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat renovate-validation-output.log >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚úÖ All configuration files validated successfully!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Show helpful error message
        if: failure()
        run: |
          cat << 'EOF' >> $GITHUB_STEP_SUMMARY
          
          ## ‚ùå Renovate Configuration Validation Failed
          
          Your Renovate configuration contains errors that need to be fixed.
          
          ### What went wrong:
          
          The validator found one or more issues with your configuration files:
          
          **Steps to fix:**
          
          1. Review the validation output above for specific error messages
          2. Check the [Renovate Configuration Options documentation](https://docs.renovatebot.com/configuration-options/)
          3. Verify that:
             - Only valid options are used in \`customManagers\`
             - Top-level options like \`pinDigests\` are not used inside \`customManagers\`
             - All required fields are present and properly formatted
             - JSON5 syntax is correct (trailing commas, valid escapes)
          
          ### Quick help links:
          
          - [Custom Managers docs](https://docs.renovatebot.com/configuration-options/#custommanagers)
          - [Config Validation docs](https://docs.renovatebot.com/config-validation/)
          - [Common errors](https://github.com/renovatebot/renovate/issues?q=is%3Aissue+label%3Aconfig+error)
          
          üí° **Pro tip:** Run \`npx --yes --package renovate -- renovate-config-validator --no-global .github/renovate-config.js\` locally to test your config before pushing!
          
          EOF

      - name: Fail if validation failed
        if: failure()
        run: |
          echo "::error::Renovate configuration validation failed. Check the validation output above for details."
          exit 1
